// Generated by CoffeeScript 1.7.1
(function() {
  var ExpressChat;

  ExpressChat = {};

  ExpressChat.View = Backbone.View.extend({
    el: "#application",
    events: {
      "click input[type='submit']": "sendMessage"
    },
    initialize: function() {
      this.room = $("#room").val();
      window.messages.sort(function(a, b) {
        a = moment(a.timestamp).toDate();
        b = moment(b.timestamp).toDate();
        if (a < b) {
          return -1;
        } else {
          if (a > b) {
            return 1;
          } else {
            return 0;
          }
        }
      });
      _.each(window.messages, (function(_this) {
        return function(message) {
          return _this.renderMessage(message);
        };
      })(this));
      _.each(window.people, (function(_this) {
        return function(person) {
          return _this.renderPerson(person);
        };
      })(this));
      this.faye = new Faye.Client('/faye');
      this.messagesSubscription = this.faye.subscribe("/chat-messages/" + this.room, (function(_this) {
        return function(message) {
          return _this.renderMessage(message);
        };
      })(this));
      return this.peopleSubscription = this.faye.subscribe("/people/" + this.room, (function(_this) {
        return function(person) {
          return _this.renderPerson(person);
        };
      })(this));
    },
    sendMessage: function(event) {
      var emailField, messageField, payload, roomField;
      event.preventDefault();
      emailField = this.$el.find("#email");
      messageField = this.$el.find("#message");
      roomField = this.$el.find("#room");
      payload = {
        email: emailField.val(),
        body: messageField.val(),
        name: this.name,
        location: this.location,
        room: roomField.val()
      };
      messageField.val("");
      return $.post('/message', payload);
    },
    renderMessage: function(message) {
      var html;
      html = new EJS({
        url: '/javascripts/chat/_message.ejs'
      }).render({
        message: message
      });
      return $("#messages").append(html);
    },
    renderPerson: function(person) {
      var html;
      if (!($("#people").find("[data-email='" + person.email + "']").length > 0)) {
        html = new EJS({
          url: '/javascripts/chat/_person.ejs'
        }).render({
          person: person
        });
        return $("#people").append(html);
      }
    }
  });

  $(function() {
    return window.application = new ExpressChat.View();
  });

}).call(this);
